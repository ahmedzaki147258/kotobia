<!-- <p>
  book-details works! whoooooooohooooooooooooo!
</p> -->

@if (book) {
  <div class="mt-13 flex flex-col md:flex-row gap-14 p-10 max-w-6xl mx-auto bg-base-200 shadow-2xl rounded-3xl overflow-hidden border border-gray-200">
    <div class="flex-shrink-0 mx-auto md:mx-0">
      <img
        [src]="book.image"
        [alt]="book.title"
        class="w-80 h-auto rounded-xl shadow-lg transition-transform duration-300 hover:scale-105"
      />
    </div>

    <div class="flex-1 p-6 space-y-6">
      <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight border-b-4 border-blue-400 pb-2">
        {{ book.title }}
      </h1>

      <p class="text-lg text-indigo-700 font-semibold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-3A2.25 2.25 0 008.25 5.25V9m7.5 0V5.25m0 0a2.25 2.25 0 00-2.25-2.25h-3A2.25 2.25 0 008.25 5.25M15.75 9V6a3 3 0 00-3-3H8.25m-1.5 0A3 3 0 004.5 6v3m-1.5 0h15" />
        </svg>
        <span>Author(s): <span class="underline">{{ book.author.join(', ') }}</span></span>
      </p>

      <p class="text-lg">
        <strong class="text-gray-800 font-medium">Price:</strong>
        <span class="text-green-600 text-2xl font-bold tracking-wide">
          ${{ book.price }}
        </span>
      </p>

      <p class="text-base text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg border-l-4 border-gray-400 shadow-sm">
        <strong class="text-gray-900">Description:</strong> {{ book.description }}
      </p>

      <!-- TODO!!  -->
      <!-- make out of stock in red, text should be in BLACK -->
      <p class="text-lg flex items-center gap-2">
        <strong class="text-gray-800"></strong>
        <span
          [class.text-red-600]="book.stock <= 0"
          [class.text-green-600]="book.stock > 0"
          class="text-xl font-semibold px-3 py-1 rounded-md"
          [ngClass]="{ 'bg-red-100': book.stock <= 0, 'bg-green-100': book.stock > 0 }"
        >
          {{ book.stock > 0 ? "In Stock" : 'Out of Stock' }}
        </span>
      </p>

      <button
        (click)="addToCart(book._id)"
        class="bg-gradient-to-r from-blue-500 to-blue-700 text-white text-lg font-medium px-6 py-3 rounded-lg shadow-md transition-all duration-300 hover:from-blue-600 hover:to-blue-800 hover:shadow-lg active:scale-95"
      >
        Add to Cart
      </button>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="mt-8 max-w-6xl mx-auto p-10 bg-gray-100 rounded-3xl shadow-lg">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">Reviews</h2>

    @if (reviews.length > 0) {
      <div class="space-y-6">
        @for (review of reviews; track review._id) {
          <div class="bg-white p-6 rounded-lg shadow-md">
            @if (editingReview && editingReview._id === review._id) {
              <!-- Edit Review Form -->
              <form (ngSubmit)="updateReview()">
                <div class="mb-4">
                  <label class="block text-gray-700">Rating</label>
                  <input
                    type="number"
                    [(ngModel)]="editingReview.rating"
                    name="rating"
                    min="1"
                    max="5"
                    class="w-full p-2 border rounded"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-gray-700">Review</label>
                  <textarea
                    [(ngModel)]="editingReview.review"
                    name="review"
                    class="w-full p-2 border rounded"
                    required
                  ></textarea>
                </div>
                <button
                  type="submit"
                  class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                >
                  Save Changes
                </button>
                <button
                  type="button"
                  (click)="editingReview = null"
                  class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 ml-2"
                >
                  Cancel
                </button>
              </form>
            } @else {
              <!-- Display Review -->
              <p class="text-gray-700">{{ review.review }}</p>
              <p class="text-sm text-gray-500 mt-2">Rating: {{ review.rating }}/5</p>
              <p class="text-sm text-gray-500 mt-2">By: {{ review.user.name }}</p>
              <p class="text-sm text-gray-500 mt-2">For: {{ review.book.title }}</p>
              
                <!-- show only if this review is yours -->
                 @if(review.user._id === newReview.user._id){
                   <button
                     (click)="startEditReview(review)"
                     class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mt-2"
                   >
                     Edit
                   </button>
                 }
              
              @if(newReview.user.role === "admin"){
                <!-- <script> console.log (newReview.user) </script> -->
                <button
                  (click)="deleteReview(review._id)"
                  class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 mt-2 ml-2"
                >
                  Delete
                </button>
              }
            }
          </div>
        }
      </div>
    } @else {
      <!-- No Reviews Message -->
      <p class="text-gray-600 mb-4">No reviews yet. Be the first to review this book!</p>
    }

    <!-- Add Review Button (Visible if no reviews or when not editing) -->
    @if (!editingReview) {
      <button
        (click)="showAddReviewForm = true"
        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
      >
        Add a Review
      </button>
    }

    <!-- Add Review Form (Visible when showAddReviewForm is true) -->
    @if (showAddReviewForm) {
      <div class="mt-6">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Add Your Review</h3>
        <form (ngSubmit)="addReview()">
          <div class="mb-4">
            <label class="block text-gray-700">Rating</label>
            <input
              type="number"
              [(ngModel)]="newReview.rating"
              name="rating"
              min="1"
              max="5"
              class="w-full p-2 border rounded"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700">Review</label>
            <textarea
              [(ngModel)]="newReview.review"
              name="review"
              class="w-full p-2 border rounded"
              required
            ></textarea>
          </div>
          <button
            type="submit"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            Submit Review
          </button>
          <button
            type="button"
            (click)="showAddReviewForm = false"
            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 ml-2"
          >
            Cancel
          </button>
        </form>
      </div>
    }
  </div>
} @else {
  <div class="text-center text-2xl font-semibold text-gray-600 mt-8 animate-pulse">
    Book Doesn't Exist....
  </div>
}
